
# Multiwire Labs DXP50 USB User Mode device driver

The Multiwiare Labs USB Driver (mwldxp50usbumdf2driver) is a 64 bit driver suitable for windows 10 and 11 64 bit systems. It is based on the
Windows User Mode Driver Framework in order to provide the maximum resilience. It is built to be compatible with selected Cypress EzUSB driver Device IO Controls
which has been used previously on 32 bit systems.  

The new driver is required to provide hardware access on 64 bit systems, since windows 32 bit has 
ceased support and Windows 10 itself will be EOL Oct 2025. 

64 bit drivers are required to be signed by a suitable certificate, no exceptions. With test signing enabled, it is possible to use a self signed certificate provided by Microsoft in the Windows Driver Kit so long as that certificate 
has been added to the Trusted Root Certification Authorities store via certmgr. Kernel mode drivers are required to be signed by Microsoft after Windows Hardware Qualification Lab qualification, using a signing certificate which must be acquired from one of four trusted vendors.  Multiwire has acquired an extended verification signing certificate from SSL.com. 

Signing requirements are much more reasonable using the User Mode Driver Framework, which allows the driver to be
directly by the Extended Verification signing certificate. The SSL.com Root Authorityi and signing certificates also needs to be
installed into the certificate store once per machine, but after that the driver will be trusted by the system. From the standpoint of the application there is no difference between accessing the user mode and kernel mode drivers.

## Loading MWLDXP50USBUMDF2Driver 

The first item of business is to download the build artifact from github. This artifact is a zip file generated by
the Continous Integration build pipeline on github and represents the current state of the build. The artifact
will only be generated if the build succeeds.

Click on the name of one of the runs (eg "Remove old code. Add readme" which has succeeded (with a green check).

![MWL DXP50 Usb UMDF 2 Driver repository actions page](./img/MWLDXP50USBUMDF2Driver-github-actions-page.png?raw=true )

then 

![MWL DXP50 Usb Umdf 2 Driver repository actions build page](./img/MWLDXP50USBUMDF2Driver-github-actions-artifact-page.png?raw=true )

The artifact will be under the artifacts section of the build page. Clicking on the artifact will begin a download 
of the zip. Then extract the zip.

You will see:
```
    Directory: C:\Users\brcamp\Downloads\MWLDXP50USBUMDF2Driver-Windows-x64-Debug


    Mode                 LastWriteTime         Length Name
    ----                 -------------         ------ ----
    -a----         3/29/2024  10:58 AM           2441 MWLDXP50USBUMDF2Driver.cat
    -a----         3/29/2024  10:58 AM            782 MWLDXP50USBUMDF2Driver.cer
    -a----         3/29/2024  10:58 AM           2900 MWLDXP50USBUMDF2Driver.inf
    -a----         3/29/2024  10:58 AM         741376 MWLDXP50USBUMDF2Driver.pdb
    -a----         3/29/2024  10:58 AM          62664 MWLDXP50USBUMDF2Driver.dll
```

### Preparing the Machine for a Debug Install

The driver will not load without the signing certificate (in this case MWLDXP50USBUMDF2Driver.cer) being loaded into thei
certificate store "Trusted Root Certificate Authorities" and turning on test signing.  This only has to be done once per machine.
The WDK test signing certificate lasts for years once installed.

You will need to enable test signing for the debug package.  In an administrator powershell or administrator cmd window, enter:
```
  bcdedit /set TestSigning on
```
Then restart the machine. Changes in bcdedit always require a restart.

In order to load the driver the signing certificate needs to be installed.
```
   certmgr
```
will get the certificate manager up, like so:

![MWL DXP50 Usb UMDF 2 Driver certmgr](./img/MWLDXP50USBUMDF2Driver-certmgr.png?raw=true )

Right click on Trusted Root Certificate Authorities" followed by "All Tasks" and Import". 

![mwl Usb Driver certmgr import]( ./img/cert-import.png?raw=true )

The next pane will ask for a certificate file. Select "Browse" and browse to the extracted zip file, which will have the drivers signing certificate (MWLDXP50USBUMDF2Driver.cer). Select that.
The following pane will confirm the selection and that you are importing to "Trusted Root Certificate Authorities". Select "Next"

![mwl Usb Driver certmgr import]( ./img/cert-import-2.png?raw=true )

Finally the certificate manager will ask you to confirm everything and actually perform the import. Select "finish".

![mwl Usb Driver certmgr import]( ./img/cert-import-3.png?raw=true )

### Loading the driver

Load the driver needs to be loaded into the driver store and registered with Windows. This is done via the utility pnputil.exe. To install the driver,
you need to be in and administrator powershell or cmd windows.  Change directory to the location of the extracted files from the artifact zip and enter:
```
   pnputil -i -a MWLDXP50USBUMDF2Driver.inf
```
which will bring up a popup asking you to confirm, even though the certificate is installed, and is from microsoft, it is not a production signed driver, so windows complains.

![MWL DXP50 Usb UMDF 2 Driver install popup]( ./img/MWLDXP50USBUMDF2Driver-install.png?raw=true )

Select "Install anyway".
```

 C:\Users\user\source\repos\MWLDXP50USBUMDF2Driver\MWL USB Driver\x64\Debug\MWL USB Driver> pnputil -i -a .\MWLDXP50USBUMDF2Driver.inf
 Microsoft PnP Utility

 Processing inf :            MWLDXP50USBUMDF2Driver.inf
 Successfully installed the driver.
 Driver package added successfully.
 Published name :            oem17.inf


 Total attempted:              1
 Number successfully imported: 1

```
Notice that the driver has been renamed to "oem17.inf". Windows will rename the drvier for internal use to oemxx.inf, so when it comes to to reinstall a new driver, you
must first uninstall the old one using pnputil.  If you don't know the name of the driver "oemxx" then enumerate the drivers using pnputil.exe
```
  pnputil -enum-drivers

```
will produce a list. The MWLDXP50USBUMDF2Driver will be recognisable from the original name and provider name. 
```
Published Name:     oem17.inf
Original Name:      MWLDXP50USBUMDF2Driver.inf
Provider Name:      Multiwire Laboratories Ltd
Class Name:         Universal Serial Bus devices
Class GUID:         {88bae032-5a81-49f0-bc3d-a4ff138216d6}
Driver Version:     03/29/2024 10.58.8.994
Signer Name:        Unknown
```
So delete the old driver
```
PS C:\Users\user\source\repos\MWLDXP50USBUMDF2Driver\x64\Debug\MWL DXP50 USB UMDF 2 Driver> pnputil -f -d oem17.inf
Microsoft PnP Utility

Driver package deleted successfully.
```
then reinstall.  

The machine does not have to be restarted for the driver to take effect.  You can now debug the driver via windbg if you wish, or just use it.


### Signing the Release Package

The build artifact for the release build is unsigned so that it can be signed by the Multiwire SSL.com EV signing certificate. The signing process is documented by SSL.com here ![ signing link ](https://www.ssl.com/how-to/automate-ev-code-signing-with-signtool-or-certutil-esigner/)

Before signing on a machine, you must install the SSL CKA package onto the signing machine. This is already done on the git runner machine.

Once the CKA is installed, you must also download the siging keys from the SSL.com site.  This is also done on the github runner machine. We will put them in 'c:/signing'. Unpack the zip.
```
    Directory: C:\signing\multiwire laboratories, ltd_


Mode                 LastWriteTime         Length Name
----                 -------------         ------ ----
------         5/16/2024   7:08 PM           2508 multiwire laboratories, ltd_.crt
------         5/16/2024   7:08 PM           2443 SSL_COM_EV_CODE_SIGNING_INTERMEDIATE_CA_RSA_R3.crt
------         5/16/2024   7:08 PM           2114 SSL_COM_EV_ROOT_CERTIFICATION_AUTHORITY_RSA_R2.crt
```

Using certmgr, import the certificates to the "Personal" store.

To sign, download the zip file from the build artifact link, which will be in the same location as the debug package.
Unpack the package in a directory, then use sign tool to sigh the .cat file and the .inf.

```
 $env:ROOT_CERT_FILE="C:\signing\multiwire laboratories, ltd_/SSL_COM_EV_ROOT_CERTIFICATION_AUTHORITY_RSA_R2.crt"

 &"C:\Program Files (x86)\Windows Kits\10\bin\10.0.19041.0\x64\signtool.exe" sign /v /fd sha256 /ac "$env:ROOT_CERT_FILE" /s my /n "multiwire laboratories, ltd" /tr http://ts.ssl.com MWL*.cat
 &"C:\Program Files (x86)\Windows Kits\10\bin\10.0.19041.0\x64\signtool.exe" sign /v /fd sha256 /ac "$env:ROOT_CERT_FILE" /s my /n "multiwire laboratories, ltd" /tr http://ts.ssl.com MWL*.inf
```

This will bring up a dialog box from the SSL.com CKA for each invokation of signtool. Note that signing with the certificates does not work without a countersign from the SSL.com CKA. 

![CKA Dialog](./img/esigner-dialog.png?raw=true )

Provide the SSL.com web site user and password. An additional one time password will be requested. Go to the SSL.com
page, to the "show QR code" area. This will provide a one time password as an 8 digit code.

![CKA Dialog](./img/ssl-otp-page.png?raw=true )

Enter the one time password code when asked.

### Installing the Release Package


## Building MWLDXP50USBUMDF2Driver 

The MWULSUBDriver is very sensitive to build tool versions and order of installation. It is currently built using:
- Visual Studio 2019 Community Edition (Pro and Enterprise work also if you have them)
- Windows SDK version 19041
- Windows Driver Kit version 19041

There is probably some flxibility in the versions, but we have seen issues with using other version of the kits.  It would probably work to 
use Visual Studio version 2022 with both SDK version 19041 and WDK Version 19041 plus SDK version 22621, but 19041 is reliable. The reason for the 
issues is that 32 bit driver building has been removed from WDK 22621 (currently the most recent version) with some collateral damage for 
driver projects that include 32 bit targets.

The good news is so long as the github actions build continues to work, there should be very little need to build the driver locally.

To build the driver, after performing all of the installations in the order listed, bring up Visual Studio 2019 (or 2022 if you are feeling lucky) 
and select "open solution file" selecting "MWL USB Driver.sln".  


## MWL DXP50 USB UMDF 2 Driver Github actions

The MWLDXP50USBUMDF2Driver repo has been set up with github actions to build the driver on every git push.  If the build fails, the push should be rejected and the reason can be determined 
by viewing the build run logs. The action workflow has been set up with a local runner on a beelink mini2, which will be connected to a live detector, so tests can be run by the 
actions workflow to verify the driver not only builds, but functions correctly.  

Github actions process is controlled by a series of scripts in the repo's .github directory. The top level 
of the action is the workflow file, msbuild.yml. The actions call a series of scripts under .github/externals.

The repo is set up to run the actions on the NUC, MINI2.  This will allow a for connecting the build process to a DXP50
card or full detector installation as part of the merge process, ensuring that the release will always be functional.

There is a python script (test.py) which is intended to run as part of the CI. Time constraints have precluded running the test script automatically from 

## Debugging tools recommended

We recommend the use of windbg using a net kernel connection on a remote machine for debugging the driver, if required. We also recommend installing wireshark on the debugging machine. 
Wireshark is able to sniff not only netowrk, but USB connections and display the resulting communications with selectable filters. This allows you to see what is happening in real time
and save it for later analysis.
